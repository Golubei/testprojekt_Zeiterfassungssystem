<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Audit der Änderungen</title>
    <style>
        body { font-family: Arial, sans-serif; }
        h1 { font-size:2.2em; margin-bottom:20px; }
        .filter-block {
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }
        .filter-block label {
            font-size: 1em;
            margin-right: 12px;
        }
        .btn {
            padding: 6px 18px;
            border-radius:4px;
            border:1px solid #bdbdbd;
            background:#e0e0e0;
            color: #222;
            cursor:pointer;
            font-size: 1em;
            font-weight: normal;
            margin-top:2px;
            margin-right:4px;
            transition: background 0.2s;
        }
        .btn:hover { background: #cacaca; }
        .btn:disabled { background: #ddd; color:#999; }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 16px;
            font-size: 1em;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        th { background: #f0f0f0; }
        tr:nth-child(even) td { background: #f7f7f7; }
        .audit-details-table {
            border-collapse: collapse;
            margin: 4px 0 0 0;
            width: 98%;
            font-size: 0.98em;
        }
        .audit-details-table th, .audit-details-table td {
            border: 1px solid #bbb;
            padding: 4px 8px;
            text-align: left;
            vertical-align: top;
        }
        .audit-details-table th { background: #eaeaea; }
        .audit-details-table tr:nth-child(even) td { background: #f5f5f5; }
        pre { margin:0; font-size:0.98em; }
        @media (max-width:900px) {
            table, th, td { font-size: 0.95em; }
            .filter-block { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <h1>Audit der Änderungen</h1>
    <div style="margin-bottom:20px;">
    <a href="/chef/dashboard" class="btn">Zurück zum Dashboard</a>
</div>
    <div class="filter-block">
        <label>Aktion: 
            <select id="filter-action">
                <option value="">Alle</option>
                <option value="edit">Bearbeitung</option>
                <option value="delete">Löschen</option>
                <option value="nachbuchung">Nachbuchung</option>
            </select>
        </label>
        <label>User: 
            <select id="filter-user">
                <option value="">Alle</option>
                <!-- Динамічно додаються співробітники -->
            </select>
        </label>
        <label>Von: <input type="date" id="filter-start"></label>
        <label>Bis: <input type="date" id="filter-end"></label>
        <button class="btn" onclick="loadAudit()">Filtern</button>
    </div>
    <table id="audit-table">
        <thead>
    <tr>
        <th>Datum/Uhrzeit</th>
        <th>Aktion</th>
        <th>User</th>
        <th>Session-ID</th>
        <th>Поле</th>
        <th>Було</th>
        <th>Стало</th>
    </tr>
</thead>
<tbody></tbody>
    </table>
    <script>
        // Завантаження списку співробітників у select
        function fillUserSelect() {
            fetch("/api/users")
                .then(r => r.json())
                .then(users => {
                    let sel = document.getElementById("filter-user");
                    sel.innerHTML = '<option value="">Alle</option>';
                    for (let u of users) {
                        sel.innerHTML += `<option value="${u.id}">${u.name}</option>`;
                    }
                });
        }

        // Встановити поточний місяць у фільтрі "Von" - "Bis"
        function setDefaultDates() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const firstDay = `${year}-${month.toString().padStart(2, '0')}-01`;
            const lastDayNum = new Date(year, month, 0).getDate();
            const lastDay = `${year}-${month.toString().padStart(2, '0')}-${lastDayNum}`;
            document.getElementById("filter-start").value = firstDay;
            document.getElementById("filter-end").value = lastDay;
        }

        // Відображає деталі аудиту як табличку "було-стало", якщо це JSON, інакше як текст/пре
        function renderAuditDetails(details) {
            let html = '';
            // Спробуємо розпарсити як JSON
            let parsed = null;
            if (typeof details === 'object') {
                parsed = details;
            } else if (typeof details === 'string') {
                try {
                    parsed = JSON.parse(details);
                } catch (e) {
                    parsed = null;
                }
            }
            if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
                html += '<table class="audit-details-table">';
                html += '<tr><th>Поле</th><th>Було</th><th>Стало</th></tr>';
                for (let key in parsed) {
                    // Якщо об'єкт має old/new
                    if (parsed[key] && typeof parsed[key] === 'object' && 'old' in parsed[key] && 'new' in parsed[key]) {
                        html += `<tr>
                            <td>${key}</td>
                            <td>${parsed[key].old === undefined ? '' : parsed[key].old}</td>
                            <td>${parsed[key].new === undefined ? '' : parsed[key].new}</td>
                        </tr>`;
                    }
                }
                html += '</table>';
            } else {
                // fallback - просто текст/пре
                html = `<pre style="white-space:pre-wrap;">${details}</pre>`;
            }
            return html;
        }

        // Основна функція завантаження аудиту
function loadAudit() {
    let params = [];
    let action = document.getElementById('filter-action').value;
    let user = document.getElementById('filter-user').value;
    let start = document.getElementById('filter-start').value;
    let end = document.getElementById('filter-end').value;
    if (action) params.push('action=' + encodeURIComponent(action));
    if (user) params.push('user_id=' + encodeURIComponent(user));
    if (start) params.push('start_date=' + encodeURIComponent(start));
    if (end) params.push('end_date=' + encodeURIComponent(end));
    let url = '/api/audit?' + params.join('&');
    fetch(url)
        .then(r => r.json())
        .then(data => {
            let tbody = document.querySelector('#audit-table tbody');
            tbody.innerHTML = '';
            if (data.success) {
                if (data.logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#888;">Keine Daten für gewählte Filter</td></tr>';
                }
                for (let log of data.logs) {
                    // Очікуємо, що log.details — це JSON з одним ключем (наприклад, comment)
                    let field = '';
                    let was = '';
                    let became = '';
                    if (typeof log.details === 'object') {
                        for (let key in log.details) {
                            if (log.details[key] && typeof log.details[key] === 'object'
                                && 'old' in log.details[key] && 'new' in log.details[key]) {
                                field = key;
                                was = log.details[key].old;
                                became = log.details[key].new;
                                break;
                            }
                        }
                    } else if (typeof log.details === 'string') {
                        try {
                            let parsed = JSON.parse(log.details);
                            for (let key in parsed) {
                                if (parsed[key] && typeof parsed[key] === 'object'
                                    && 'old' in parsed[key] && 'new' in parsed[key]) {
                                    field = key;
                                    was = parsed[key].old;
                                    became = parsed[key].new;
                                    break;
                                }
                            }
                        } catch (e) {
                            field = '';
                            was = log.details;
                            became = '';
                        }
                    }
                    let tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${log.timestamp}</td>
                        <td>${log.action}</td>
                        <td>${log.user}</td>
                        <td>${log.session_id || ''}</td>
                        <td>${field}</td>
                        <td>${was}</td>
                        <td>${became}</td>
                    `;
                    tbody.appendChild(tr);
                }
            } else {
                tbody.innerHTML = '<tr><td colspan="7">Fehler: ' + (data.error || 'Unbekannt') + '</td></tr>';
            }
        })
        .catch(e => {
            let tbody = document.querySelector('#audit-table tbody');
            tbody.innerHTML = '<tr><td colspan="7">Serverfehler!</td></tr>';
        });
}

        window.onload = function() {
            fillUserSelect();
            setDefaultDates();
            loadAudit();
        };
    </script>
</body>
</html>