<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Chef Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; }
        h1 { font-size: 2.5em; }
        .main-btn, .logout-btn {
            background: #e0e0e0;
            color: #222;
            padding: 6px 16px;
            border: 1px solid #bdbdbd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
            margin-top: 10px;
            transition: background 0.2s;
            display: inline-block;
        }
        .main-btn:hover, .logout-btn:hover { background: #cacaca; }
        #clock { font-size: 1.5em; font-weight: bold; margin-bottom: 15px; }
        #session-block { margin-bottom: 20px; }
        #comment-modal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3);}
        #comment-modal .modal-content { background:#fff; padding:20px; max-width:350px; margin:8vh auto; border-radius:7px; box-shadow:0 2px 16px #2225; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; table-layout: fixed; }
        th, td { border:1px solid #bbb; padding:5px 10px; text-align:left; }
        th { background:#f0f0f0; }
        .form-block { margin: 20px 0; padding: 12px; background: #f8f8f8; border-radius: 7px; }
        button.main-btn[disabled] { opacity: 0.5; cursor: not-allowed; }
        .table-container { width: 100%; min-width: 900px; }
        #period-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 16px;
        }
        #period-filter label { margin-bottom: 0; white-space: nowrap; }
    </style>
</head>
<body>
    <h1>Hallo Chef!</h1>
    <div id="clock"></div>
    <div style="margin-bottom: 10px;">
        <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        <a href="{{ url_for('chef_statistik') }}" class="logout-btn">Statistik</a>
    </div>
    <!-- --- Створення користувача --- -->
    <div class="form-block">
        <form method="post">
            <button type="submit" name="show_user_form" class="main-btn">Mitarbeiter anlegen</button>
            {% if user_form_visible %}
            <div>
                <label>Vorname: <input type="text" name="first_name" required></label>
                <label>Nachname: <input type="text" name="last_name" required></label>
                <label>E-Mail: <input type="email" name="email" required></label>
                <label>Passwort: <input type="password" name="password" required></label>
                <label>Passwort wiederholen: <input type="password" name="password2" required></label>
                <button type="submit" name="create_user" class="main-btn">Anlegen</button>
            </div>
            {% endif %}
        </form>
    </div>
    <!-- --- Створення клієнта --- -->
    <div class="form-block">
        <form method="post">
            <button type="submit" name="show_client_form" class="main-btn">Client anlegen</button>
            {% if client_form_visible %}
            <div>
                <label>Name: <input type="text" name="name" required></label>
                <button type="submit" name="create_client" class="main-btn">Anlegen</button>
            </div>
            {% endif %}
        </form>
    </div>
    <!-- --- СТАРТ/СТОП сесії для шефа --- -->
    <div id="session-block"></div>
    <!-- --- Модальне вікно для коментаря --- -->
    <div id="comment-modal">
        <div class="modal-content">
            <label for="comment-input">Kommentar (Pflicht):</label><br>
            <textarea id="comment-input" rows="3" style="width:100%"></textarea>
            <br>
            <button id="comment-ok" class="main-btn" disabled>OK</button>
        </div>
    </div>
    <button class="main-btn" id="nachbuchung-btn" style="font-size:1.2em;margin-bottom:10px;">+</button>
    <div id="nachbuchung-row"></div>
    <div class="table-container">
        <div id="period-filter" style="margin-bottom:16px;"></div>
        <div id="buchungen-table"></div>
    </div>
    <div id="confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25);z-index:1001;">
        <div style="background:#fff;padding:22px 24px;max-width:380px;margin:12vh auto;border-radius:9px;box-shadow:0 2px 16px #2225;">
            <div id="confirm-text" style="margin-bottom:18px;font-size:1.2em;">Bist du sicher?</div>
            <button id="confirm-yes" class="main-btn">OK</button>
            <button id="confirm-no" class="main-btn">Abbrechen</button>
        </div>
    </div>
    <script>
    // --- Live Clock ---
    function pad(n) { return n < 10 ? "0" + n : n; }
    function updateClock() {
        const now = new Date();
        let y = now.getFullYear(), m = pad(now.getMonth()+1), d = pad(now.getDate());
        let h = pad(now.getHours()), min = pad(now.getMinutes()), s = pad(now.getSeconds());
        document.getElementById('clock').textContent = `${d}.${m}.${y}, ${h}:${min}:${s}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // --- Jinja-змінні ---
    let activeSession = {% if active_session and active_session.id is not none %}{{ active_session.id }}{% else %}null{% endif %};
    let sessionEnd = {% if active_session and active_session.end_time %}"{{ active_session.end_time.isoformat() }}"{% else %}null{% endif %};
    let userRole = "{{ user_role }}";
    let clients = {{ clients|tojson }};
    let users = {{ users|tojson if users else '[]' }};
    let currentUserName = "{{ current_user.first_name if current_user else '' }} {{ current_user.last_name if current_user else '' }}";

    // --- Session Block (Chef як User) ---
    function renderSessionBlock() {
        const sessionBlock = document.getElementById('session-block');
        if (!activeSession) {
            let html = '<label>Kunde wählen: <select id="client-select"><option value="">Bitte wählen</option>';
            clients.forEach(c => html += `<option value="${c.id}">${c.name}</option>`);
            html += '</select></label> ';
            html += '<button class="main-btn" id="start-btn" disabled>Arbeitsbeginn</button>';
            sessionBlock.innerHTML = html;
            document.getElementById('client-select').addEventListener('change', function(){
                document.getElementById('start-btn').disabled = !this.value;
            });
            document.getElementById('start-btn').addEventListener('click', function(){
                let client_id = document.getElementById('client-select').value;
                fetch('/api/start_session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({client_id: client_id})
                })
                .then(r => r.json())
                .then(data => {
                    if(data.success){
                        activeSession = data.session_id;
                        renderSessionBlock();
                        renderBuchungen();
                    } else {
                        alert(data.error || "Fehler beim Starten.");
                    }
                });
            });
        } else if (activeSession && !sessionEnd) {
            sessionBlock.innerHTML = '<button class="main-btn" id="end-btn">Arbeitende</button>';
            document.getElementById('end-btn').onclick = function(){
                fetch('/api/end_session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({session_id: activeSession})
                })
                .then(r=>r.json())
                .then(data=>{
                    if(data.success){
                        showCommentModal();
                    } else {
                        alert(data.error || "Fehler beim Beenden.");
                    }
                });
            };
        }
    }
    function showCommentModal() {
        const modal = document.getElementById('comment-modal');
        const input = document.getElementById('comment-input');
        const okBtn = document.getElementById('comment-ok');
        input.value = "";
        okBtn.disabled = true;
        modal.style.display = "block";
        input.oninput = function() {
            okBtn.disabled = !input.value.trim();
        };
        okBtn.onclick = function() {
            fetch('/api/finish_session', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({session_id: activeSession, comment: input.value.trim()})
            }).then(r=>r.json()).then(data=>{
                if(data.success){
                    modal.style.display = "none";
                    activeSession = null;
                    sessionEnd = null;
                    renderSessionBlock();
                    renderBuchungen();
                } else {
                    alert(data.error || "Fehler beim Speichern des Kommentars.");
                }
            });
        };
    }
    window.onclick = function(event) {
        const modal = document.getElementById('comment-modal');
        if (event.target === modal) modal.style.display = "none";
    };

    // --- Confirm Modal ---
    function showConfirmModal(text, onyes) {
        document.getElementById('confirm-text').textContent = text;
        document.getElementById('confirm-modal').style.display = 'block';
        document.getElementById('confirm-yes').onclick = function() {
            document.getElementById('confirm-modal').style.display = 'none';
            onyes && onyes();
        };
        document.getElementById('confirm-no').onclick = function() {
            document.getElementById('confirm-modal').style.display = 'none';
        };
    }

    // --- Buchungenübersicht ---
    let filterClient = "";
    let filterUser = "";
    let filterStartDate = "";
    let filterEndDate = "";
    let editingRowId = null;

    // --- Встановити дефолтні дати фільтра на поточний місяць ---
    (function setDefaultPeriodFilter(){
        let now = new Date();
        let yyyy = now.getFullYear();
        let mm = String(now.getMonth() + 1).padStart(2, '0');
        let firstDay = `${yyyy}-${mm}-01`;
        let today = `${yyyy}-${mm}-${String(now.getDate()).padStart(2, '0')}`;
        filterStartDate = firstDay;
        filterEndDate = today;
    })();

    function setDefaultPeriodFilter(){
        let now = new Date();
        let yyyy = now.getFullYear();
        let mm = String(now.getMonth() + 1).padStart(2, '0');
        let firstDay = `${yyyy}-${mm}-01`;
        let today = `${yyyy}-${mm}-${String(now.getDate()).padStart(2, '0')}`;
        filterStartDate = firstDay;
        filterEndDate = today;
        filterUser = "";
        filterClient = "";
    }

    function renderPeriodFilter() {
        let html = `
            <label>Mitarbeiter: <select id="filter-user"><option value="">Alle</option>
                ${users.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}
            </select></label>
            <label>Kunde: <select id="filter-client"><option value="">Alle</option>
                ${clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
            </select></label>
            <label>Von: <input type="date" id="filter-startdate"></label>
            <label>Bis: <input type="date" id="filter-enddate"></label>
            <button class="main-btn" id="period-ok">Ok</button>
            <button class="main-btn" id="period-reset" style="margin-left:8px;">Reset</button>
        `;
        document.getElementById('period-filter').innerHTML = html;

        document.getElementById('filter-client').value = filterClient;
        document.getElementById('filter-user').value = filterUser;
        document.getElementById('filter-startdate').value = filterStartDate;
        document.getElementById('filter-enddate').value = filterEndDate;

        document.getElementById('period-ok').onclick = function() {
            filterClient = document.getElementById('filter-client').value;
            filterUser = document.getElementById('filter-user').value;
            filterStartDate = document.getElementById('filter-startdate').value;
            filterEndDate = document.getElementById('filter-enddate').value;
            renderBuchungen();
        };

        document.getElementById('period-reset').onclick = function() {
            setDefaultPeriodFilter();
            renderBuchungen();
        };
    }

    function renderBuchungen() {
        renderPeriodFilter();
        let params = [];
        if (filterUser && filterUser !== "") params.push("user_id="+encodeURIComponent(filterUser));
        if (filterClient && filterClient !== "") params.push("client_id="+encodeURIComponent(filterClient));
        if (filterStartDate) params.push("start_date="+encodeURIComponent(filterStartDate));
        if (filterEndDate) params.push("end_date="+encodeURIComponent(filterEndDate));
        fetch('/api/session_history' + (params.length ? "?" + params.join("&") : ""))
            .then(r=>r.json())
            .then(data=>{
                let html = "<table><tr>";
                html+="<th>Mitarbeiter</th><th>Kunde</th><th>Beginn</th><th>Ende</th><th>Kommentar</th><th></th></tr>";
                for(let row of data){
                    let canEdit = true, canDelete = true;
                    if (activeSession) canEdit = canDelete = false;
                    if (editingRowId === row.id) {
                        html += "<tr>";
                        html += `<td>${row.user}</td>`;
                        html += `<td><select id="edit-client">`+clients.map(c=>
                            `<option value="${c.id}" ${c.name===row.client?'selected':''}>${c.name}</option>`).join('')+`</select></td>`;
                        html += `<td><input id="edit-start" type="datetime-local" value="${row.start_time.replace(' ', 'T')}" /></td>`;
                        html += `<td><input id="edit-end" type="datetime-local" value="${row.end_time ? row.end_time.replace(' ', 'T') : ''}" /></td>`;
                        html += `<td><input id="edit-comment" type="text" value="${row.comment||''}" style="width:90px;"/></td>`;
                        html += `<td>
                            <button class="main-btn" id="save-row">💾</button>
                            <button class="main-btn" id="cancel-row">✖</button>
                        </td></tr>`;
                    } else {
                        html += "<tr>";
                        html += `<td>${row.user}</td>`;
                        html += `<td>${row.client}</td><td>${row.start_time}</td><td>${row.end_time||""}</td><td>${row.comment||""}</td>`;
                        html += `<td>
                            <button class="main-btn" ${canEdit?'':'disabled'} id="edit-${row.id}">📝</button>
                            <button class="main-btn" ${canDelete?'':'disabled'} id="del-${row.id}">🗑️</button>
                        </td></tr>`;
                    }
                }
                html += "</table>";
                document.getElementById('buchungen-table').innerHTML = html;
                data.forEach(row=>{
                    let editBtn = document.getElementById('edit-'+row.id);
                    if(editBtn) editBtn.onclick = function(){
                        if(editingRowId && editingRowId!==row.id) return;
                        editingRowId = row.id;
                        renderBuchungen();
                    };
                    let delBtn = document.getElementById('del-'+row.id);
                    if(delBtn) delBtn.onclick = function(){
                        showConfirmModal("Bist du sicher, dass du diese Sitzung löschen willst?", ()=>{
                            fetch(`/api/session/${row.id}`, {method:'DELETE'})
                            .then(r=>r.json())
                            .then(res=>{
                                if(res.success){
                                    renderBuchungen();
                                } else {
                                    alert(res.error||"Fehler beim Löschen");
                                }
                            });
                        });
                    };
                });
                let saveBtn = document.getElementById('save-row');
                if(saveBtn) saveBtn.onclick = function(){
                    showConfirmModal("Bist du sicher, dass du die Änderungen speichern willst?", ()=>{
                        let payload = {
                            client_id: document.getElementById('edit-client').value,
                            start_time: formatDateForBackend(document.getElementById('edit-start').value),
                            end_time: formatDateForBackend(document.getElementById('edit-end').value),
                            comment: document.getElementById('edit-comment').value
                        };
                        fetch(`/api/session/${editingRowId}`, {
                            method: 'PUT',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify(payload)
                        })
                        .then(r=>r.json())
                        .then(res=>{
                            if(res.success){
                                editingRowId = null;
                                renderBuchungen();
                            } else {
                                alert(res.error||"Fehler beim Speichern");
                            }
                        });
                    });
                };
                let cancelBtn = document.getElementById('cancel-row');
                if(cancelBtn) cancelBtn.onclick = function(){
                    editingRowId = null;
                    renderBuchungen();
                };
            });
    }
    function formatDateForBackend(dtstr) {
        if (!dtstr) return "";
        return dtstr.replace('T',' ');
    }

    document.addEventListener("DOMContentLoaded", function(){
        document.getElementById('nachbuchung-btn').onclick = function(){
            renderNachbuchungRow();
        };
        renderSessionBlock();
        renderBuchungen();
    });

    function renderNachbuchungRow() {
        const container = document.getElementById('nachbuchung-row');
        if (container.innerHTML.trim()) return;
        let html = `
            <table><tr>
                <td>
                    <select id="nach-user">
                        <option value="">Mitarbeiter wählen</option>
                        ${users.map(u=>`<option value="${u.id}">${u.name}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <select id="nach-client">
                        <option value="">Kunde wählen</option>
                        ${clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
                    </select>
                </td>
                <td><input id="nach-start" type="datetime-local"></td>
                <td><input id="nach-end" type="datetime-local"></td>
                <td><input id="nach-comment" type="text" placeholder="Kommentar"></td>
                <td>
                    <button class="main-btn" id="nach-ok" disabled>OK</button>
                    <button class="main-btn" id="nach-cancel">✖</button>
                </td>
            </tr></table>
        `;
        container.innerHTML = html;
        function validate() {
            const isValid = document.getElementById('nach-user').value &&
                document.getElementById('nach-client').value &&
                document.getElementById('nach-start').value &&
                document.getElementById('nach-end').value &&
                document.getElementById('nach-comment').value.trim();
            document.getElementById('nach-ok').disabled = !isValid;
        }
        ['nach-user','nach-client', 'nach-start', 'nach-end', 'nach-comment'].forEach(id=>{
            document.getElementById(id).oninput = validate;
        });
        document.getElementById('nach-cancel').onclick = ()=>{
            container.innerHTML = "";
        };
        document.getElementById('nach-ok').onclick = ()=>{
            if (window.confirm("Bist du sicher, dass du diese Nachbuchung anlegen willst?")) {
                fetch('/api/nachbuchung', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        user_id: document.getElementById('nach-user').value,
                        client_id: document.getElementById('nach-client').value,
                        start_time: document.getElementById('nach-start').value.replace('T',' ') + ":00",
                        end_time: document.getElementById('nach-end').value.replace('T',' ') + ":00",
                        comment: document.getElementById('nach-comment').value.trim()
                    })
                })
                .then(r=>r.json())
                .then(res=>{
                    if(res.success){
                        container.innerHTML = "";
                        renderBuchungen();
                    } else {
                        alert(res.error||"Fehler beim Erstellen!");
                    }
                })
                .catch(e => alert("Fehler beim Netzwerk/Server: " + e));
            }
        };
    }
    </script>
</body>
</html>