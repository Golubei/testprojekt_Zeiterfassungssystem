<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; }
        h1 { font-size: 2.5em; }
        .main-btn, .logout-btn {
            background: #e0e0e0;
            color: #222;
            padding: 6px 16px;
            border: 1px solid #bdbdbd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
            margin-top: 10px;
            transition: background 0.2s;
            display: inline-block;
        }
        .main-btn:hover, .logout-btn:hover { background: #cacaca; }
        #clock { font-size: 1.5em; font-weight: bold; margin-bottom: 15px; }
        #session-block { margin-bottom: 20px; }
        #comment-modal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3);}
        #comment-modal .modal-content { background:#fff; padding:20px; max-width:350px; margin:8vh auto; border-radius:7px; box-shadow:0 2px 16px #2225; }
        #buchungen-filter { margin-bottom: 20px; }
        table { border-collapse:collapse; width:100%; margin-top:10px; }
        th,td { border:1px solid #bbb; padding:5px 10px; text-align:left; }
        th { background:#f0f0f0; }
        button.main-btn[disabled] { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>Willkommen im Dashboard!</h1>
    <div id="clock"></div>
    <div id="session-block"></div>
    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>

    <!-- Модальне вікно для коментаря -->
    <div id="comment-modal">
      <div class="modal-content">
        <label for="comment-input">Kommentar (Pflicht):</label><br>
        <textarea id="comment-input" rows="3" style="width:100%"></textarea>
        <br>
        <button id="comment-ok" class="main-btn" disabled>OK</button>
      </div>
    </div>
    <div id="buchungen-filter"></div>
    <button class="main-btn" id="nachbuchung-btn" style="font-size:1.2em;margin-bottom:10px;">+</button>
    <div id="nachbuchung-row"></div>
    <div id="buchungen-table"></div>
    <div id="confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25);z-index:1001;">
      <div style="background:#fff;padding:22px 24px;max-width:380px;margin:12vh auto;border-radius:9px;box-shadow:0 2px 16px #2225;">
        <div id="confirm-text" style="margin-bottom:18px;font-size:1.2em;">Bist du sicher?</div>
        <button id="confirm-yes" class="main-btn">OK</button>
        <button id="confirm-no" class="main-btn">Abbrechen</button>
      </div>
    </div>
<script>
// --- Всі глобальні дані (тільки ОДИН РАЗ!) ---
let activeSession = {{ active_session.id if active_session and active_session.id is not none else 'null' }};
let sessionEnd = {{ '"' + active_session.end_time.isoformat() + '"' if active_session and active_session.end_time else 'null' }};
let userRole = "{{ user_role }}";
let clients = {{ clients|tojson }};
let users = {{ users|tojson if users else '[]' }};
let currentUserName = "{{ current_user.first_name if current_user else '' }} {{ current_user.last_name if current_user else '' }}";
let filterClient = "";
let editingRowId = null;

// --- Live Clock ---
function pad(n) { return n < 10 ? "0" + n : n; }
function updateClock() {
    const now = new Date();
    let y = now.getFullYear(), m = pad(now.getMonth()+1), d = pad(now.getDate());
    let h = pad(now.getHours()), min = pad(now.getMinutes()), s = pad(now.getSeconds());
    document.getElementById('clock').textContent = `${d}.${m}.${y}, ${h}:${min}:${s}`;
}
setInterval(updateClock, 1000);
updateClock();

// --- Session Block ---
function renderSessionBlock() {
    const sessionBlock = document.getElementById('session-block');
    if (!activeSession) {
        let html = '<label>Kunde wählen: <select id="client-select"><option value="">Bitte wählen</option>';
        clients.forEach(c => html += `<option value="${c.id}">${c.name}</option>`);
        html += '</select></label> ';
        html += '<button class="main-btn" id="start-btn" disabled>Arbeitsbeginn</button>';
        sessionBlock.innerHTML = html;
        document.getElementById('client-select').addEventListener('change', function(){
            document.getElementById('start-btn').disabled = !this.value;
        });
        document.getElementById('start-btn').addEventListener('click', function(){
            let client_id = document.getElementById('client-select').value;
            fetch('/api/start_session', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({client_id: client_id})
            })
            .then(r => r.json())
            .then(data => {
                if(data.success){
                    activeSession = data.session_id;
                    renderSessionBlock();
                    renderBuchungen();
                } else {
                    alert(data.error || "Fehler beim Starten.");
                }
            });
        });
    } else if (activeSession && !sessionEnd) {
        sessionBlock.innerHTML = '<button class="main-btn" id="end-btn">Arbeitende</button>';
        document.getElementById('end-btn').onclick = function(){
            fetch('/api/end_session', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({session_id: activeSession})
            })
            .then(r=>r.json())
            .then(data=>{
                if(data.success){
                    showCommentModal();
                } else {
                    alert(data.error || "Fehler beim Beenden.");
                }
            });
        };
    }
}
function showCommentModal() {
    const modal = document.getElementById('comment-modal');
    const input = document.getElementById('comment-input');
    const okBtn = document.getElementById('comment-ok');
    input.value = "";
    okBtn.disabled = true;
    modal.style.display = "block";
    input.oninput = function() {
        okBtn.disabled = !input.value.trim();
    };
    okBtn.onclick = function() {
        fetch('/api/finish_session', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({session_id: activeSession, comment: input.value.trim()})
        }).then(r=>r.json()).then(data=>{
            if(data.success){
                modal.style.display = "none";
                activeSession = null;
                sessionEnd = null;
                renderSessionBlock();
                renderBuchungen();
            } else {
                alert(data.error || "Fehler beim Speichern des Kommentars.");
            }
        });
    };
}
window.onclick = function(event) {
    const modal = document.getElementById('comment-modal');
    if (event.target === modal) modal.style.display = "none";
};

// --- Confirm Modal ---
function showConfirmModal(text, onyes) {
    document.getElementById('confirm-text').textContent = text;
    document.getElementById('confirm-modal').style.display = 'block';
    document.getElementById('confirm-yes').onclick = function() {
        document.getElementById('confirm-modal').style.display = 'none';
        onyes && onyes();
    };
    document.getElementById('confirm-no').onclick = function() {
        document.getElementById('confirm-modal').style.display = 'none';
    };
}

// --- Buchungenübersicht ---
function renderFilters() {
    let html = "";
    html += '<label>Kunde: <select id="filter-client"><option value="">Alle</option>';
    clients.forEach(c => html += `<option value="${c.id}">${c.name}</option>`);
    html += '</select></label> ';
    document.getElementById('buchungen-filter').innerHTML = html;
    document.getElementById('filter-client').value = filterClient;
    document.getElementById('filter-client').onchange = function() {
        filterClient = this.value;
        renderBuchungen();
    }
}
function formatDateForBackend(val) {
    if (!val) return "";
    if (val.length === 16) return val.replace('T', ' ') + ":00";
    return val.replace('T', ' ');
}
function renderBuchungen() {
    renderFilters();
    let params = [];
    if (filterClient) params.push("client_id="+encodeURIComponent(filterClient));
    fetch('/api/session_history' + (params.length ? "?" + params.join("&") : ""))
        .then(r=>r.json())
        .then(data=>{
            let now = new Date();
            let thisMonth = now.getMonth(), thisYear = now.getFullYear();
            let html = "<table><tr><th>Kunde</th><th>Beginn</th><th>Ende</th><th>Kommentar</th><th></th></tr>";
            for(let row of data){
                let canEdit = false, canDelete = false;
                // User може редагувати тільки свої записи у межах поточного місяця
                let start = new Date(row.start_time.replace(' ', 'T'));
                if (row.user === currentUserName && start.getMonth() === thisMonth && start.getFullYear() === thisYear) {
                    canEdit = canDelete = true;
                }
                if (activeSession) canEdit = canDelete = false;
                if (editingRowId === row.id) {
                    html += "<tr>";
                    html += `<td><select id="edit-client">`+clients.map(c=>
                        `<option value="${c.id}" ${c.name===row.client?'selected':''}>${c.name}</option>`).join('')+`</select></td>`;
                    html += `<td><input id="edit-start" type="datetime-local" value="${row.start_time.replace(' ', 'T')}" /></td>`;
                    html += `<td><input id="edit-end" type="datetime-local" value="${row.end_time ? row.end_time.replace(' ', 'T') : ''}" /></td>`;
                    html += `<td><input id="edit-comment" type="text" value="${row.comment||''}" style="width:90px;"/></td>`;
                    html += `<td>
                        <button class="main-btn" id="save-row">💾</button>
                        <button class="main-btn" id="cancel-row">✖</button>
                    </td></tr>`;
                } else {
                    html += "<tr>";
                    html += `<td>${row.client}</td><td>${row.start_time}</td><td>${row.end_time||""}</td><td>${row.comment||""}</td>`;
                    html += `<td>
                        <button class="main-btn" ${canEdit?'':'disabled'} id="edit-${row.id}">📝</button>
                        <button class="main-btn" ${canDelete?'':'disabled'} id="del-${row.id}">🗑️</button>
                    </td></tr>`;
                }
            }
            html += "</table>";
            document.getElementById('buchungen-table').innerHTML = html;
            data.forEach(row=>{
                let editBtn = document.getElementById('edit-'+row.id);
                if(editBtn) editBtn.onclick = function(){
                    if(editingRowId && editingRowId!==row.id) return;
                    editingRowId = row.id;
                    renderBuchungen();
                };
                let delBtn = document.getElementById('del-'+row.id);
                if(delBtn) delBtn.onclick = function(){
                    showConfirmModal("Bist du sicher, dass du diese Sitzung löschen willst?", ()=>{
                        fetch(`/api/session/${row.id}`, {method:'DELETE'})
                        .then(r=>r.json())
                        .then(res=>{
                            if(res.success){
                                renderBuchungen();
                            } else {
                                alert(res.error||"Fehler beim Löschen");
                            }
                        });
                    });
                };
            });
            let saveBtn = document.getElementById('save-row');
            if(saveBtn) saveBtn.onclick = function(){
                // --- Перевірка поточного календарного місяця ---
                let startVal = document.getElementById('edit-start').value;
                let endVal = document.getElementById('edit-end').value;
                let now = new Date();
                let allowedMonth = now.getMonth();
                let allowedYear = now.getFullYear();
                let startDate = startVal ? new Date(startVal) : null;
                let endDate = endVal ? new Date(endVal) : null;
                if (
                    (startDate && (startDate.getMonth() !== allowedMonth || startDate.getFullYear() !== allowedYear)) ||
                    (endDate && (endDate.getMonth() !== allowedMonth || endDate.getFullYear() !== allowedYear))
                ) {
                    alert("Bearbeitungsfehler! Änderungen sind nur im Kalendermonat möglich!");
                    return;
                }
                showConfirmModal("Bist du sicher, dass du die Änderungen speichern willst?", ()=>{
                    let payload = {
                        client_id: document.getElementById('edit-client').value,
                        start_time: formatDateForBackend(startVal),
                        end_time: formatDateForBackend(endVal),
                        comment: document.getElementById('edit-comment').value
                    };
                    fetch(`/api/session/${editingRowId}`, {
                        method: 'PUT',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify(payload)
                    })
                    .then(r=>r.json())
                    .then(res=>{
                        if(res.success){
                            editingRowId = null;
                            renderBuchungen();
                        } else {
                            alert(res.error||"Fehler beim Speichern");
                        }
                    });
                });
            };
            let cancelBtn = document.getElementById('cancel-row');
            if(cancelBtn) cancelBtn.onclick = function(){
                editingRowId = null;
                renderBuchungen();
            };
        });
}

// --- Nachbuchung ---
function renderNachbuchungRow() {
    const container = document.getElementById('nachbuchung-row');
    if (container.innerHTML.trim()) return; // prevent duplicate form

    let html = `
        <table><tr>
            <td>
                <select id="nach-client">
                    <option value="">Kunde wählen</option>
                    ${clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
                </select>
            </td>
            <td><input id="nach-start" type="datetime-local"></td>
            <td><input id="nach-end" type="datetime-local"></td>
            <td><input id="nach-comment" type="text" placeholder="Kommentar"></td>
            <td>
                <button class="main-btn" id="nach-ok" disabled>OK</button>
                <button class="main-btn" id="nach-cancel">✖</button>
            </td>
        </tr></table>
    `;
    container.innerHTML = html;

    function validate() {
        const isValid = document.getElementById('nach-client').value &&
            document.getElementById('nach-start').value &&
            document.getElementById('nach-end').value &&
            document.getElementById('nach-comment').value.trim();
        document.getElementById('nach-ok').disabled = !isValid;
    }
    ['nach-client', 'nach-start', 'nach-end', 'nach-comment'].forEach(id=>{
        document.getElementById(id).oninput = validate;
    });

    document.getElementById('nach-cancel').onclick = ()=>{
        container.innerHTML = "";
    };

    document.getElementById('nach-ok').onclick = ()=>{
        let startVal = document.getElementById('nach-start').value;
        let endVal = document.getElementById('nach-end').value;
        let now = new Date();
        let allowedMonth = now.getMonth();
        let allowedYear = now.getFullYear();
        let startDate = startVal ? new Date(startVal) : null;
        let endDate = endVal ? new Date(endVal) : null;
        if (
            (startDate && (startDate.getMonth() !== allowedMonth || startDate.getFullYear() !== allowedYear)) ||
            (endDate && (endDate.getMonth() !== allowedMonth || endDate.getFullYear() !== allowedYear))
        ) {
            alert("Eine Nachbuchung ist nur innerhalb eines Kalendermonats möglich!");
            return;
        }
        if (window.confirm("Bist du sicher, dass du diese Nachbuchung anlegen willst?")) {
            fetch('/api/nachbuchung', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    client_id: document.getElementById('nach-client').value,
                    start_time: document.getElementById('nach-start').value.replace('T',' ') + ":00",
                    end_time: document.getElementById('nach-end').value.replace('T',' ') + ":00",
                    comment: document.getElementById('nach-comment').value.trim()
                })
            })
            .then(r=>r.json())
            .then(res=>{
                if(res.success){
                    container.innerHTML = "";
                    renderBuchungen();
                } else {
                    alert(res.error||"Fehler beim Erstellen!");
                }
            });
        }
    };
}

document.addEventListener("DOMContentLoaded", function(){
    document.getElementById('nachbuchung-btn').onclick = function(){
        renderNachbuchungRow();
    };
    renderSessionBlock();
    renderBuchungen();
});
</script>
</body>
</html>